arch: x86_64
vmType: qemu
cpus: 4
memory: 4GiB
disk: 20GiB

containerd:
  system: false
  user: false

user:
  name: ubuntu

mounts:
  - location: "~/dev/fasts3/"
    writable: true

networks:
  - socket: /opt/homebrew/var/run/socket_vmnet

images:
  - location: "https://cloud-images.ubuntu.com/releases/focal/release/ubuntu-20.04-server-cloudimg-amd64.img"
    arch: x86_64

firmware:
  legacyBIOS: true

provision:
  - mode: system
    script: |
      #!/usr/bin/env bash
      set -euxo pipefail
      export DEBIAN_FRONTEND=noninteractive

      # Enable universe repository for ibverbs-utils
      add-apt-repository -y universe
      apt-get update

      # Install basic utilities
      apt-get install -y --no-install-recommends \
        curl ca-certificates sudo bash git xz-utils lsb-release make

      useradd -m -s /bin/bash -G sudo ubuntu || true

      cat > /etc/sudoers.d/90-sudo-nopasswd <<'EOF'
      %sudo ALL=(ALL) NOPASSWD: ALL
      EOF
      chmod 0440 /etc/sudoers.d/90-sudo-nopasswd

      apt-get update

      # Install kernel modules - try specific version first, fallback to generic
      KERNEL_VERSION=$(uname -r)
      apt-get install -y --no-install-recommends linux-modules-extra-${KERNEL_VERSION} || \
        apt-get install -y --no-install-recommends linux-modules-extra-generic || true

      # Install RDMA packages
      apt-get install -y --no-install-recommends \
        rdma-core \
        rdmacm-utils \
        ibverbs-utils \
        ibverbs-providers \
        libibverbs-dev \
        librdmacm-dev \
        build-essential \
        iproute2 \
        ethtool \
        pciutils \
        tcpdump

      # Load RDMA RXE module and configure
      modprobe rdma_rxe || true
      PRIMARY_IFACE=$(ip route | grep default | awk '{print $5}' | head -n1)
      rdma link add rxe0 type rxe netdev "$PRIMARY_IFACE" || true

  - mode: user
    script: |
      #!/usr/bin/env bash
      set -euxo pipefail
      echo "RDMA development environment ready."
